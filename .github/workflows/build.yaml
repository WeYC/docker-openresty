name: Build Docker Image

on:
  push:
    branches:
      - main  # åœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches:
      - main  # åœ¨æäº¤æ‹‰å–è¯·æ±‚æ—¶è§¦å‘
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu
    env:
      TAG_NAME: '1.25.3.2-2'  # è®¾ç½® TAG_NAME ç¯å¢ƒå˜é‡
      
    steps:
      - name: Checkout repository  #æ£€å‡ºæœ¬ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: Move the README.me file to tmp
        run: |
          echo "ğŸ‰ğŸ‰ğŸ‰${PWD}"
          ls -l
          if [ -f "README.me" ];then
            echo "ğŸ‰ğŸ‰ğŸ‰ Move README.md files"
            mv README.me /tmp/
          fi
          ls -l /tmp
        
      - name: Checkout specific tag from external repository
        uses: actions/checkout@v4
        with:
          repository: 'openresty/docker-openresty'  # ä» OpenResty Docker ä»“åº“æ£€å‡ºä»£ç 
          ref: 'refs/tags/${{ env.TAG_NAME }}' # æ£€å‡ºæŒ‡å®šæ ‡ç­¾

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3  # è®¾ç½® QEMU ä»¥æ”¯æŒå¤šå¹³å°æ„å»º

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3  # è®¾ç½® Docker Buildx ç”¨äºæ”¯æŒå¤šå¹³å°æ„å»º

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache  # Docker æ„å»ºå±‚ç¼“å­˜
          key: ${{ runner.os }}-buildx-${{ github.sha }}  # ä½¿ç”¨ GitHub SHA ä½œä¸ºç¼“å­˜å¯†é’¥
          restore-keys: ${{ runner.os }}-buildx-  # ç¼“å­˜æ¢å¤é”®

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # Docker Hub ç”¨æˆ·å
          password: ${{ secrets.DOCKERHUB_TOKEN }}  # Docker Hub è®¿é—®ä»¤ç‰Œ

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .  # è®¾ç½®æ„å»ºä¸Šä¸‹æ–‡
          file: ./focal/Dockerfile  # æŒ‡å®š Dockerfile è·¯å¾„
          platforms: |
            linux/arm/v7
          push: true  # æ¨é€é•œåƒåˆ°ä»“åº“
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/openresty:${{ env.TAG_NAME }}-focal  # æ¨é€åˆ° Docker Hub
          cache-from: type=gha  # ä½¿ç”¨ GitHub Actions çš„ç¼“å­˜åŠ é€Ÿæ„å»º
          cache-to: type=gha,mode=max  # ä½¿ç”¨ GitHub Actions ç¼“å­˜ï¼Œæœ€å¤§åŒ–ç¼“å­˜åˆ©ç”¨

      - name: Move the README.me file to $PWD
        run: |
          echo "ğŸ‰ğŸ‰ğŸ‰${PWD}"
          ls -l
          if [ -f "README.me" ];then
            echo "ğŸ‰ğŸ‰ğŸ‰ Move README.md files"
            mv -f /tmp/README.me $PWD/
          fi
          ls -l $PWD | grep "README.md"

      - name: Docker Hub Description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ secrets.DOCKERHUB_USERNAME }}/openresty
          readme-filepath: ./README.md
          

